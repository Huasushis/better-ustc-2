# 登录功能实现

本文档描述了 Better-USTC-2 项目中登录功能的实现细节，包括前端和后端的交互流程。

## 登录方式

项目支持两种登录方式：

1. **前端网页登录**：前端打开浏览器页面进行登录，获取 token 并传递给后端。
2. **后端爬取登录**：后端通过模拟网页请求进行登录，获取并存储 token。

## 登录流程

### 触发登录的场景

以下情况需要进行登录操作（如果已登录则跳过）：

- 应用启动时检测登录状态，返回未登录。
- 其他操作时后端返回未登录错误码。
- 用户手动进入账号密码修改界面。

### 详细流程

1. **前端检测登录状态**：
   - 前端调用后端 `get_login_status` 函数。
   - 若未登录，后端返回包含保存的账号密码（如果有）。

2. **显示登录界面**：
   - 前端打开自定义登录页面。
   - 自动填入保存的账号密码（如果有）。
   - 用户手动输入或修改账号密码。

3. **提交登录请求**：
   - 用户点击确定后，前端调用后端 `login` 函数，传入账号和密码。
   - 前端进行登录操作：
     - 打开浏览器页面 `https://id.ustc.edu.cn`。
     - 自动填入账号密码并点击登录。
     - 处理可能的 2FA（两因素认证）或其他验证步骤。

4. **获取并存储 Token**：
   - 登录成功后，后端获取 token。
   - 加密存储用户账号密码和 token。
   - 返回登录成功状态给前端。

5. **处理登录失败**：
   - 若登录失败，返回错误信息（例如账号密码错误、网络问题等）。
   - 前端根据错误码显示相应提示，并允许用户重试。

### 注意事项

- 所有敏感信息（如密码、token）必须加密存储。
- 登录过程中可能需要用户手动完成 2FA 等步骤。
- 后端需要处理网络超时、页面变化等异常情况。
- 前端应提供友好的错误提示和重试机制。

### 示例代码（前端）

```typescript
// 前端调用登录
async function handleLogin(username: string, password: string) {
  const result = await invoke<boolean>('login', { username, password });
  if (result) {
    // 登录成功，跳转到主界面
  } else {
    // 登录失败，显示错误提示
  }
}
```

### 示例代码（后端）

```rust
#[tauri::command]
async fn login(username: String, password: String) -> Result<bool, String> {
    // 实现登录逻辑
    // ...
    Ok(true) // 或 Err("错误信息".to_string())
}
```
